# 加密PDF密碼輸入功能測試指南

## ✅ 實作完成項目

### 1. 信號與槽機制
已在 `IntegratedApp` 類別新增三個 PyQt 信號：
- `password_requested` - 請求密碼輸入
- `wrong_password` - 密碼錯誤通知
- `decrypt_error` - 解密錯誤通知

**位置**: [src/integrated_app.py:1152-1154](src/integrated_app.py#L1152-L1154)

### 2. 密碼輸入方法
- `get_password(filename)` - 彈出密碼輸入對話框
- `wait_for_password()` - 等待並返回密碼結果
- `show_wrong_password_warning(filename)` - 顯示密碼錯誤警告
- `show_decrypt_error(error_message)` - 顯示解密錯誤

**位置**: [src/integrated_app.py:1202-1256](src/integrated_app.py#L1202-L1256)

### 3. 執行緒安全處理
- 使用信號槽機制確保 UI 操作在主執行緒執行
- 實作事件循環等待機制（`QEventLoop`）
- 最大等待時間：60秒

## 🧪 測試步驟

### 準備測試檔案

1. 執行測試腳本建立加密PDF：
   ```bash
   python test_password.py
   ```

2. 將產生以下測試檔案於 `test_files/` 目錄：
   - `test_normal.pdf` - 未加密
   - `test_encrypted_simple.pdf` - 密碼: `123456`
   - `test_encrypted_complex.pdf` - 密碼: `MyP@ssw0rd!`
   - `test_encrypted_chinese.pdf` - 密碼: `測試密碼`

### 測試案例

#### 測試案例 1：單一加密PDF合併
**目標**: 測試基本密碼輸入功能

1. 啟動應用程式：
   ```bash
   python src/integrated_app.py
   ```

2. 切換到「多文件合併PDF」標籤頁

3. 點擊「添加檔案」，選擇 `test_encrypted_simple.pdf`

4. 設定輸出路徑

5. 點擊「開始合併」

**預期結果**:
- ✅ 彈出密碼輸入對話框，顯示檔案名稱
- ✅ 輸入正確密碼 `123456` 後繼續合併
- ✅ 合併成功完成

#### 測試案例 2：密碼錯誤重試
**目標**: 測試密碼錯誤處理

1. 添加 `test_encrypted_simple.pdf`

2. 點擊「開始合併」

3. 輸入錯誤密碼（如 `wrong`）

**預期結果**:
- ✅ 顯示「密碼錯誤」警告對話框
- ✅ 再次彈出密碼輸入對話框
- ✅ 可以重新輸入正確密碼

#### 測試案例 3：使用者取消
**目標**: 測試取消操作

1. 添加 `test_encrypted_simple.pdf`

2. 點擊「開始合併」

3. 在密碼對話框點擊「取消」

**預期結果**:
- ✅ 顯示錯誤訊息：「已取消操作，因為未提供 'xxx' 的密碼」
- ✅ 合併操作終止
- ✅ UI 恢復可操作狀態

#### 測試案例 4：混合加密與未加密PDF
**目標**: 測試混合檔案處理

1. 依序添加以下檔案：
   - `test_normal.pdf` (未加密)
   - `test_encrypted_simple.pdf` (密碼: `123456`)
   - `test_encrypted_complex.pdf` (密碼: `MyP@ssw0rd!`)

2. 點擊「開始合併」

**預期結果**:
- ✅ 處理第一個檔案（未加密）無需密碼
- ✅ 處理第二個檔案時彈出密碼輸入
- ✅ 輸入 `123456` 後繼續
- ✅ 處理第三個檔案時再次彈出密碼輸入
- ✅ 輸入 `MyP@ssw0rd!` 後完成合併

#### 測試案例 5：中文密碼
**目標**: 測試特殊字元與中文密碼

1. 添加 `test_encrypted_chinese.pdf`

2. 點擊「開始合併」

3. 輸入中文密碼 `測試密碼`

**預期結果**:
- ✅ 密碼輸入對話框支援中文輸入
- ✅ 中文密碼正確識別
- ✅ 解密成功

#### 測試案例 6：多次密碼錯誤
**目標**: 測試重複錯誤處理

1. 添加 `test_encrypted_simple.pdf`

2. 點擊「開始合併」

3. 連續輸入3次錯誤密碼

4. 第4次輸入正確密碼

**預期結果**:
- ✅ 每次錯誤後都顯示警告並重新請求
- ✅ 最終輸入正確密碼後成功解密

## 🔍 除錯資訊

程式在執行時會在控制台輸出除錯訊息：

```
get_password called for file: test_encrypted_simple.pdf
Password dialog result: ok=True, password_length=6
wait_for_password returning: result=123456, ok=True
```

這些訊息可協助診斷密碼輸入流程問題。

## 📋 驗證檢查清單

執行所有測試案例後，確認以下項目：

- [ ] 密碼對話框正常彈出並顯示檔案名稱
- [ ] 正確密碼可成功解密
- [ ] 錯誤密碼顯示警告並允許重試
- [ ] 取消操作正確處理
- [ ] 混合檔案（加密+未加密）正確處理
- [ ] 中文密碼支援正常
- [ ] 多次錯誤後仍可成功輸入
- [ ] 超時機制正常（60秒）
- [ ] UI 不會凍結
- [ ] 進度條正常更新

## 🐛 已知限制

1. **等待機制**: 使用輪詢方式（100ms間隔）等待密碼輸入，可能有些延遲
2. **超時設定**: 最大等待60秒，超時後需要重新執行
3. **控制台輸出**: Windows下可能有中文編碼顯示問題（不影響功能）

## 🔧 疑難排解

### 問題：密碼對話框沒有彈出
**解決方案**:
- 檢查控制台是否有錯誤訊息
- 確認 `password_requested` 信號已正確連接
- 檢查主視窗參考是否正確傳遞給 `MergePdfThread`

### 問題：輸入正確密碼後仍顯示錯誤
**解決方案**:
- 確認密碼沒有多餘空格
- 檢查PDF檔案是否真的使用該密碼加密
- 使用其他PDF工具驗證密碼

### 問題：程式凍結
**解決方案**:
- 檢查是否進入無限等待
- 查看控制台輸出的 `wait_for_password` 訊息
- 確認事件循環正常運作

## 📝 後續改善建議

1. **改善等待機制**: 使用 QWaitCondition 取代輪詢
2. **密碼提示**: 允許使用者查看密碼輸入（顯示/隱藏切換）
3. **記住密碼**: 在同一次合併中記住已輸入的密碼
4. **批次密碼**: 允許一次輸入多個檔案的密碼
5. **密碼管理**: 整合密碼管理器（如系統鑰匙圈）

## ✅ 測試完成標記

測試日期: __________
測試人員: __________
測試結果: ☐ 通過 ☐ 失敗
備註: ____________________